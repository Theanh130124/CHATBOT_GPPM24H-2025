{% extends 'layout/base.html' %}

{% block title %}{{ post.title }} | Chi tiết bài viết{% endblock %}

{% block content %}
<div class="post-page-bg py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-8">

        <!-- Bài viết -->
        <div class="card post-card border-0 shadow-sm rounded-4 mb-5">
          <div class="card-body p-4">
            <h1 class="fw-bold mb-3 text-dark">{{ post.title }}</h1>
            <div class="d-flex align-items-center mb-3">
              <img src="{{ post.user.avatar }}" alt="Avatar"
                   class="rounded-circle me-2 shadow-sm"
                   width="42" height="42" style="object-fit: cover;">
              <div>
                <small class="text-muted">
                  <span class="fw-semibold text-primary">{{ post.user.username }}</span>
                  &nbsp;•&nbsp;
                  {{ post.created_at.strftime('%H:%M ngày %d/%m/%Y') }}
                </small>
              </div>
            </div>

            <!-- Nhiều ảnh minh họa -->
            {% if post.images %}
            {% if post.images|length == 1 %}
              <div class="text-center mb-4">
                <img src="{{ post.images[0].image_url }}"
                     class="img-fluid rounded-4 shadow-sm post-image"
                     alt="Ảnh minh họa bài viết">
              </div>
            {% else %}
              <div id="postCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                <div class="carousel-inner rounded-4 shadow-sm">
                  {% for img in post.images %}
                  <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <img src="{{ img.image_url }}" class="d-block w-100 post-image" alt="Ảnh {{ loop.index }}">
                  </div>
                  {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#postCarousel" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#postCarousel" data-bs-slide="next">
                  <span class="carousel-control-next-icon"></span>
                </button>
              </div>
            {% endif %}
            {% endif %}

            <!-- Nội dung -->
            <div class="post-content fs-5 lh-lg text-dark mb-4">
              {{ post.content | safe }}
            </div>

            <!-- Like -->
            <form method="POST" action="{{ url_for('toggle_like', post_id=post.post_id) }}">
              <button type="submit"
                      class="btn {% if user_liked %}btn-danger{% else %}btn-outline-danger{% endif %} px-3 rounded-pill">
                {% if user_liked %}
                  <i class="bi bi-heart-fill me-1"></i>Bỏ thích
                {% else %}
                  <i class="bi bi-heart me-1"></i>Thích
                {% endif %}
                ({{ like_count }})
              </button>
            </form>
          </div>
        </div>

        <!-- Bình luận -->
        <div class="comments-section p-4 rounded-4 shadow-sm">
          <h4 class="text-primary border-bottom pb-2 mb-4">
            Bình luận ({{ comments | length }})
          </h4>

          <!-- Form bình luận -->
          <form method="POST" action="{{ url_for('add_comment', post_id=post.post_id) }}"
                class="comment-form p-3 rounded-4 mb-4">
            <div class="d-flex align-items-start">
              <img src="{{ current_user.avatar }}"
                   class="rounded-circle me-3 shadow-sm"
                   width="45" height="45" style="object-fit: cover;">
              <div class="flex-grow-1">
                <textarea name="content"
                          class="form-control mb-2 rounded-3"
                          rows="3"
                          placeholder="Viết bình luận của bạn..." required></textarea>
                <div class="text-end">
                  <button type="submit" class="btn btn-primary btn-sm px-4">
                    <i class="bi bi-send-fill me-1"></i>Gửi bình luận
                  </button>
                </div>
              </div>
            </div>
          </form>

          <!-- Danh sách bình luận -->
          <ul class="list-group list-group-flush">
            {% for c in comments %}
            <li class="list-group-item border-0 comment-item py-3 px-0">
              <div class="d-flex">
                <img src="{{ c.user.avatar }}"
                     class="rounded-circle me-3 shadow-sm"
                     width="45" height="45" alt="Avatar người dùng"
                     style="object-fit: cover;">
                <div class="flex-grow-1">
                  <h6 class="fw-bold mb-1">{{ c.user.username }}</h6>
                  <p class="mb-1 text-break text-dark">{{ c.content }}</p>
                  <small class="text-muted">{{ c.created_at.strftime('%H:%M ngày %d/%m/%Y') }}</small>
                </div>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-center text-muted py-4 border-0 bg-transparent">
              Chưa có bình luận nào. Hãy là người đầu tiên!
            </li>
            {% endfor %}
          </ul>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
.post-page-bg { background-color: #f3f6fb; min-height: 100vh; }
.post-image { max-height: 550px; object-fit: cover; border-radius: 16px; }
.comment-item:hover { background-color: #f4f7fc; }
.carousel-inner img { height: 500px; object-fit: cover; }
</style>
{% endblock %}
